<!DOCTYPE html>
<html lang="en">
<head>
  <meta property="og:title" content="üåªüíñüêªMy Crypto Trackerüòç‚≠êüçï">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MGCrypto</title>
  <link rel="icon" type="image/png" href="crown2.png">
<style>
body {
  font-family: 'Poppins', sans-serif;
  padding: 20px;
  background-color: #fdf6ef;
  color: #333;
}

.card {
  background-color: #fdf6ef;
  border: none;
  box-shadow: none;
  color: #444;
  font-weight: 500;
  border-radius: 12px;
  padding: 12px 20px;
}

.card:hover {
  background-color: #f1e8dc;
}

.card.active {
  background-color: #e7d9c5 !important;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th, td {
  padding: 10px 12px;
  text-align: center;
  border-bottom: 1px solid #e5d6c5;
}

th {
  background-color: transparent;
  color: #7a5c3c;
  font-weight: 600;
}

td.positive { color: #2e7d32; font-weight: 500; }
td.negative { color: #c62828; font-weight: 500; }

tr.updated {
  background-color: #eafce9;
  transition: background-color 1s ease;
}
    table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    table-layout: fixed; /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ */
  }

  th:nth-child(1), td:nth-child(1) { width: 120px; }
  th:nth-child(2), td:nth-child(2) { width: 80px; }
  th:nth-child(3), td:nth-child(3) { width: 110px; }
  th:nth-child(4), td:nth-child(4) { width: 110px; }
  th:nth-child(5), td:nth-child(5) { width: 120px; }
  th:nth-child(6), td:nth-child(6) { width: 120px; }
  th:nth-child(7), td:nth-child(7) { width: 100px; }

  td, th {
    white-space: nowrap;
  }
</style>
</head>
<body>
<div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
  <img src="crown2.png" alt="Logo" style="width: 60px; margin-right: 10px;">
  <span style="font-size: 28px; font-weight: 600; color: #5a412a;">ProfitTracker</span>
</div>

  <div class="port-summary" style="justify-content: flex-start; align-items: center;">
  <label for="portfolioSelect" style="margin-right: 8px; font-weight: 500;">Portfolio:</label>
  <select id="portfolioSelect" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #ccc; background-color: #fff5ea; font-family: Poppins, sans-serif;">
    <option value="high">HIGH</option>
    <option value="low">LOW</option>
    <option value="total" selected>TOTAL</option>
  </select>
</div>

  <table>
    <thead>
      <tr>
        <th>Token</th>
        <th>Chain</th>
        <th>Quantity</th>
        <th>Entry Price</th>
        <th>Current Price</th>
        <th>Total Value</th>
        <th>Profit %</th>
      </tr>
    </thead>
    <tbody id="price-table"></tbody>
  </table>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/154YVMJYcJ8_5q_hNknll3XwVwIGvNst4G13ACYpywdY/gviz/tq?tqx=out:json&sheet=OPEN%20TRADES';
    let allData = [];
    let currentType = 'total';
    let oldPrices = {};

    async function fetchSheetTokens() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));
      const rows = json.table.rows;

      return rows.slice(3).map(r => ({
        name: r.c[2]?.v?.trim(),
        chain: r.c[3]?.v?.trim(),
        contract: r.c[4]?.v?.trim(),

        highEntry: parseFloat(r.c[5]?.v || 0),
        highQty: parseFloat(r.c[6]?.v || 0),
        highInv: parseFloat(r.c[7]?.v || 0),

        lowEntry: parseFloat(r.c[8]?.v || 0),
        lowQty: parseFloat(r.c[9]?.v || 0),
        lowInv: parseFloat(r.c[10]?.v || 0),

        totalEntry: parseFloat(r.c[11]?.v || 0),
        totalQty: parseFloat(r.c[12]?.v || 0),
        totalInv: parseFloat(r.c[13]?.v || 0),
      })).filter(t => t.contract);
    }

async function enrichWithPrices(data) {
  const CHUNK_SIZE = 100;
  const DELAY_MS = 2000;
  const chunks = [...Array(Math.ceil(data.length / CHUNK_SIZE))].map((_, i) =>
    data.slice(i * CHUNK_SIZE, i * CHUNK_SIZE + CHUNK_SIZE)
  );

  let results = [];

  for (let i = 0; i < chunks.length; i++) {
    const chunk = chunks[i];
    console.log(`üîÑ Processing chunk ${i + 1}/${chunks.length}...`);

    const chunkResults = await Promise.all(chunk.map(async row => {
      try {
        const url = `https://api.dexscreener.com/latest/dex/tokens/${row.contract}`;
        const res = await fetch(url);
        const json = await res.json();
        const info = json.pairs?.[0];

        if (!info || !info.priceUsd) {
          console.warn('‚õî DexScreener ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', row.name);
          return null;
        }

        const currentPrice = parseFloat(info.priceUsd);
        return { ...row, currentPrice };
      } catch (e) {
        console.error('Error fetching price for', row.contract, e);
        return null;
      }
    }));

    results.push(...chunkResults.filter(Boolean));
    if (i < chunks.length - 1) await new Promise(r => setTimeout(r, DELAY_MS));
  }

  return results;
}

    function renderRows(data, type) {
      const tbody = document.getElementById('price-table');
      tbody.innerHTML = '';

      data.forEach(row => {
        let entry, qty, inv;
        if (type === 'high') {
          if (row.highInv === 0) return;
          entry = row.highEntry;
          qty = row.highQty;
          inv = row.highInv;
        } else if (type === 'low') {
          if (row.lowInv === 0) return;
          entry = row.lowEntry;
          qty = row.lowQty;
          inv = row.lowInv;
        } else {
          if (row.totalInv === 0) return;
          entry = row.totalEntry;
          qty = row.totalQty;
          inv = row.totalInv;
        }

        const totalValue = qty * row.currentPrice;
        const profitPct = ((row.currentPrice - entry) / entry) * 100;
        const changeClass = profitPct >= 0 ? 'positive' : 'negative';

        const tr = document.createElement('tr');
        tr.setAttribute('id', row.contract);
        tr.innerHTML = `
          <td>${row.name}</td>
          <td>${row.chain}</td>
          <td>${qty.toLocaleString()}</td>
          <td>$${entry.toFixed(6)}</td>
          <td class="price">$${row.currentPrice.toFixed(6)}</td>
          <td class="value">$${totalValue.toFixed(2)}</td>
          <td class="profit ${changeClass}">${profitPct.toFixed(2)}%</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function refreshPrices() {
      for (let row of allData) {
        try {
          const url = `https://api.dexscreener.com/latest/dex/tokens/${row.contract}`;
          const res = await fetch(url);
          const json = await res.json();
          const info = json.pairs?.[0];
          if (!info) continue;

          const newPrice = parseFloat(info.priceUsd);
          const tr = document.getElementById(row.contract);
          if (!tr) continue;

          const entry = currentType === 'high' ? row.highEntry : currentType === 'low' ? row.lowEntry : row.totalEntry;
          const qty = currentType === 'high' ? row.highQty : currentType === 'low' ? row.lowQty : row.totalQty;
          const newTotalValue = newPrice * qty;
          const newProfitPct = ((newPrice - entry) / entry) * 100;

          if (Math.abs(oldPrices[row.contract] - newPrice) > 0.000001) {
            oldPrices[row.contract] = newPrice;
            tr.querySelector('.price').textContent = `$${newPrice.toFixed(6)}`;
            tr.querySelector('.value').textContent = `$${newTotalValue.toFixed(2)}`;
            const profitTd = tr.querySelector('.profit');
            profitTd.textContent = `${newProfitPct.toFixed(2)}%`;
            profitTd.className = `profit ${newProfitPct >= 0 ? 'positive' : 'negative'}`;
            tr.classList.add('updated');
            setTimeout(() => tr.classList.remove('updated'), 1000);
          }
        } catch (e) {
          console.error('Error updating price for', row.contract, e);
        }
      }
    }

      async function main() {
          let rawData = await fetchSheetTokens();
          console.log('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô rawData ‡∏à‡∏≤‡∏Å Sheet =', rawData.length);

          allData = await enrichWithPrices(rawData);
          console.log('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô allData ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å DexScreener =', allData.length);

          updateCounts(allData);
          console.log('High items:', allData.filter(d => d.highInv > 0).map(d => d.name));
          console.log('Low items:', allData.filter(d => d.lowInv > 0).map(d => d.name));
          console.log('Total items:', allData.filter(d => d.totalInv > 0).map(d => d.name));

          allData.forEach(row => oldPrices[row.contract] = row.currentPrice);
          renderRows(allData, currentType);

      document.getElementById('portfolioSelect').addEventListener('change', e => {
        currentType = e.target.value;
        renderRows(allData, currentType);
      });

      setInterval(refreshPrices, 10000);  // ‚¨ÖÔ∏è ‡∏õ‡∏¥‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô main ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    } // ‚úÖ ‡∏õ‡∏¥‡∏î main

    function setActive(id) {
      document.querySelectorAll('.card').forEach(btn => btn.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function updateCounts(data) {
      const high = data.filter(d => d.highInv > 0);
      const low = data.filter(d => d.lowInv > 0);
      const total = data.filter(d => d.totalInv > 0);

      document.getElementById('portfolioSelect').options[0].textContent = `HIGH (${high.length})`;
      document.getElementById('portfolioSelect').options[1].textContent = `LOW (${low.length})`;
      document.getElementById('portfolioSelect').options[2].textContent = `TOTAL (${total.length})`;
    }

    main();  // ‚¨ÖÔ∏è ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

  </script>
</body>
</html>
